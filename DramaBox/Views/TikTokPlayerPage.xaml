<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="DramaBox.Views.TikTokPlayerPage"
    x:Name="Page"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    Shell.NavBarIsVisible="False"
    Shell.TabBarIsVisible="False"
    NavigationPage.HasNavigationBar="False"
    BackgroundColor="Black">

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- ========================= -->
        <!-- ROW 1 (conteúdo / vídeo) -->
        <!-- ========================= -->
        <Grid Grid.Row="1">

            <!-- Player (fundo) -->
            <toolkit:MediaElement
                x:Name="Player"
                ZIndex="0"
                InputTransparent="True"
                Aspect="AspectFill"
                ShouldAutoPlay="False"
                ShouldLoopPlayback="False"
                ShouldShowPlaybackControls="False"
                MediaEnded="OnMediaEnded" />

            <!-- Carousel (apenas para controlar Position/ScrollTo) -->
            <CarouselView x:Name="Feed"
                          ZIndex="1"
                          ItemsSource="{Binding Items}"
                          IsSwipeEnabled="False"
                          Loop="False"
                          InputTransparent="True"
                          CurrentItemChanged="OnCurrentItemChanged">
                <CarouselView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical"
                                       SnapPointsType="MandatorySingle" />
                </CarouselView.ItemsLayout>

                <CarouselView.ItemTemplate>
                    <DataTemplate>
                        <Grid BackgroundColor="#01000000" />
                    </DataTemplate>
                </CarouselView.ItemTemplate>
            </CarouselView>

            <!-- Tap + Pan SOMENTE na área do vídeo -->
            <Grid x:Name="TapLayer"
                  ZIndex="2"
                  BackgroundColor="Transparent">
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnScreenTapped" NumberOfTapsRequired="1" />
                    <PanGestureRecognizer PanUpdated="OnPanUpdated" />
                </Grid.GestureRecognizers>
            </Grid>

            <!-- Gradiente inferior -->
            <Grid ZIndex="3"
                  VerticalOptions="End"
                  HeightRequest="220"
                  InputTransparent="True">
                <Grid.Background>
                    <LinearGradientBrush StartPoint="0,1" EndPoint="0,0">
                        <GradientStop Color="#D1000000" Offset="0" />
                        <GradientStop Color="#55000000" Offset="0.55" />
                        <GradientStop Color="#00000000" Offset="1" />
                    </LinearGradientBrush>
                </Grid.Background>
            </Grid>

            <!-- Infos inferior esquerdo -->
            <Grid ZIndex="4"
                  Padding="16"
                  VerticalOptions="End"
                  HorizontalOptions="Start"
                  InputTransparent="True">
                <VerticalStackLayout Spacing="6">
                    <Label Text="{Binding Current.CreatorName}"
                           TextColor="White"
                           FontAttributes="Bold"
                           FontSize="14" />
                    <Label Text="{Binding Current.DramaTitle}"
                           TextColor="White"
                           FontSize="13" />
                    <Label Text="{Binding Current.EpisodeTitle}"
                           TextColor="White"
                           Opacity="0.75"
                           FontSize="12" />
                </VerticalStackLayout>
            </Grid>

            <!-- Botões direita (aparece quando pausado) -->
            <Grid ZIndex="6"
                  Padding="14"
                  VerticalOptions="Center"
                  HorizontalOptions="End"
                  IsVisible="{Binding IsOverlayVisible}">
                <VerticalStackLayout Spacing="12">

                    <!-- LIKE -->
                    <Border Stroke="#26FFFFFF"
                            StrokeThickness="1"
                            BackgroundColor="#33000000"
                            WidthRequest="38"
                            HeightRequest="38">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14"/>
                        </Border.StrokeShape>

                        <Border.Triggers>
                            <DataTrigger TargetType="Border"
                                         Binding="{Binding CurrentIsLiked}"
                                         Value="True">
                                <Setter Property="BackgroundColor" Value="#66FF2D2D"/>
                                <Setter Property="Stroke" Value="#66FF2D2D"/>
                            </DataTrigger>
                        </Border.Triggers>

                        <ImageButton Source="likewhite.png"
                                     BackgroundColor="Transparent"
                                     Padding="8"
                                     Clicked="OnLikeClicked"/>
                    </Border>

                    <!-- SHARE -->
                    <Border Stroke="#26FFFFFF"
                            StrokeThickness="1"
                            BackgroundColor="#33000000"
                            WidthRequest="38"
                            HeightRequest="38">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14"/>
                        </Border.StrokeShape>

                        <ImageButton Source="sharewhite.png"
                                     BackgroundColor="Transparent"
                                     Padding="8"
                                     Clicked="OnShareClicked"/>
                    </Border>

                    <!-- PLAYLIST -->
                    <Border Stroke="#26FFFFFF"
                            StrokeThickness="1"
                            BackgroundColor="#33000000"
                            WidthRequest="38"
                            HeightRequest="38">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14"/>
                        </Border.StrokeShape>

                        <Border.Triggers>
                            <DataTrigger TargetType="Border"
                                         Binding="{Binding CurrentIsSaved}"
                                         Value="True">
                                <Setter Property="BackgroundColor" Value="#665B2CC7"/>
                                <Setter Property="Stroke" Value="#665B2CC7"/>
                            </DataTrigger>
                        </Border.Triggers>

                        <ImageButton Source="pluswhite.png"
                                     BackgroundColor="Transparent"
                                     Padding="8"
                                     Clicked="OnPlaylistClicked"/>
                    </Border>

                    <!-- PRÓXIMO -->
                    <Border Stroke="#26FFFFFF"
                            StrokeThickness="1"
                            BackgroundColor="#55111827"
                            WidthRequest="38"
                            HeightRequest="38">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14"/>
                        </Border.StrokeShape>

                        <ImageButton Source="gowhite.png"
                                     BackgroundColor="Transparent"
                                     Padding="8"
                                     Clicked="OnNextClicked"/>
                    </Border>

                    <!-- VOLTAR -->
                    <Border Stroke="#26FFFFFF"
                            StrokeThickness="1"
                            BackgroundColor="#55111827"
                            WidthRequest="38"
                            HeightRequest="38">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="14"/>
                        </Border.StrokeShape>

                        <ImageButton Source="rewind.png"
                                     BackgroundColor="Transparent"
                                     Padding="8"
                                     Clicked="OnPrevClicked"/>
                    </Border>

                </VerticalStackLayout>
            </Grid>

        </Grid>

        <!-- ========================= -->
        <!-- ROW 0 (Topbar)            -->
        <!-- ========================= -->
        <Grid Grid.Row="0"
              ZIndex="10"
              Padding="14"
              VerticalOptions="Start"
              HorizontalOptions="Fill"
              ColumnDefinitions="Auto,*,Auto">

            <!-- BACK -->
            <Border Stroke="#26FFFFFF"
                    StrokeThickness="1"
                    BackgroundColor="#dd000000"
                    WidthRequest="38"
                    HeightRequest="38">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>

                <ImageButton Source="backwhite.png"
                             BackgroundColor="Transparent"
                             Padding="8"
                             Clicked="OnBackClicked"/>
            </Border>

            <!-- MENU placeholder -->
            <Border Grid.Column="2"
                    Stroke="#26FFFFFF"
                    StrokeThickness="1"
                    BackgroundColor="#dd000000"
                    WidthRequest="38"
                    HeightRequest="38"
                    Opacity="0.9">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>
                <Label Text="⋯"
                       FontSize="18"
                       TextColor="#E5E7EB"
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"/>
            </Border>
        </Grid>

    </Grid>
</ContentPage>