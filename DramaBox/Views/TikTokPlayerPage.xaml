<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="DramaBox.Views.TikTokPlayerPage"
    x:Name="Page"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    Shell.NavBarIsVisible="False"
    Shell.TabBarIsVisible="False"
    NavigationPage.HasNavigationBar="False"
    BackgroundColor="Black">

    <Grid>

        <!-- Player (fundo) -->
        <!-- No Android, deixe InputTransparent=True para não roubar gesto -->
        <toolkit:MediaElement
            x:Name="Player"
            ZIndex="0"
            InputTransparent="True"
            Aspect="AspectFill"
            ShouldAutoPlay="False"
            ShouldLoopPlayback="False"
            ShouldShowPlaybackControls="False"
            MediaEnded="OnMediaEnded" />

        <!-- Carousel (conteúdo) -->
        <!-- Deixa swipe interno DESLIGADO para não competir com Tap/Pan -->
        <CarouselView x:Name="Feed"
                      ZIndex="1"
                      ItemsSource="{Binding Items}"
                      IsSwipeEnabled="False"
                      Loop="False"
                      CurrentItemChanged="OnCurrentItemChanged">

            <CarouselView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical"
                                   SnapPointsType="MandatorySingle" />
            </CarouselView.ItemsLayout>

            <CarouselView.ItemTemplate>
                <DataTemplate>
                    <!-- "quase transparente" pro Android registrar hit-test -->
                    <Grid BackgroundColor="#01000000" />
                </DataTemplate>
            </CarouselView.ItemTemplate>
        </CarouselView>

        <!-- CAMADA DE GESTOS (Tap + Pan) -->
        <!-- Fica acima do Carousel e abaixo dos botões/topbar -->
        <Grid x:Name="GestureLayer"
              ZIndex="2"
              BackgroundColor="#01000000">

            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnScreenTapped"
                                      NumberOfTapsRequired="1" />
                <PanGestureRecognizer PanUpdated="OnPanUpdated" />
            </Grid.GestureRecognizers>

        </Grid>

        <!-- Gradiente inferior (legibilidade) -->
        <Grid ZIndex="3"
              VerticalOptions="End"
              HeightRequest="220"
              InputTransparent="True">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,1" EndPoint="0,0">
                    <GradientStop Color="#D1000000" Offset="0" />
                    <GradientStop Color="#55000000" Offset="0.55" />
                    <GradientStop Color="#00000000" Offset="1" />
                </LinearGradientBrush>
            </Grid.Background>
        </Grid>

        <!-- Infos (inferior esquerdo) -->
        <Grid ZIndex="4"
              Padding="16"
              VerticalOptions="End"
              HorizontalOptions="Start"
              InputTransparent="True">
            <VerticalStackLayout Spacing="6">
                <Label Text="{Binding Current.CreatorName}"
                       TextColor="White"
                       FontAttributes="Bold"
                       FontSize="14" />
                <Label Text="{Binding Current.DramaTitle}"
                       TextColor="White"
                       FontSize="13" />
                <Label Text="{Binding Current.EpisodeTitle}"
                       TextColor="White"
                       Opacity="0.75"
                       FontSize="12" />
            </VerticalStackLayout>
        </Grid>

        <!-- Botões direita (só quando PAUSADO) -->
        <Grid ZIndex="5"
              Padding="14"
              VerticalOptions="Center"
              HorizontalOptions="End"
              IsVisible="{Binding IsOverlayVisible}">
            <VerticalStackLayout Spacing="14">

                <!-- LIKE -->
                <Border Stroke="#26FFFFFF"
                        StrokeThickness="1"
                        BackgroundColor="#55000000"
                        WidthRequest="56"
                        HeightRequest="56">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18"/>
                    </Border.StrokeShape>

                    <ImageButton Source="likewhite.png"
                                 BackgroundColor="Transparent"
                                 Padding="14"
                                 Clicked="OnLikeClicked"/>
                </Border>

                <!-- SHARE -->
                <Border Stroke="#26FFFFFF"
                        StrokeThickness="1"
                        BackgroundColor="#55000000"
                        WidthRequest="56"
                        HeightRequest="56">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18"/>
                    </Border.StrokeShape>

                    <ImageButton Source="sharewhite.png"
                                 BackgroundColor="Transparent"
                                 Padding="14"
                                 Clicked="OnShareClicked"/>
                </Border>

                <!-- PLAYLIST -->
                <Border Stroke="#26FFFFFF"
                        StrokeThickness="1"
                        BackgroundColor="#55000000"
                        WidthRequest="56"
                        HeightRequest="56">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18"/>
                    </Border.StrokeShape>

                    <ImageButton Source="pluswhite.png"
                                 BackgroundColor="Transparent"
                                 Padding="14"
                                 Clicked="OnPlaylistClicked"/>
                </Border>

                <!-- PRÓXIMO (mantém do jeito que tava) -->
                <Border Stroke="#26FFFFFF"
                        StrokeThickness="1"
                        BackgroundColor="#55111827"
                        WidthRequest="56"
                        HeightRequest="56">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="18"/>
                    </Border.StrokeShape>

                    <Button BackgroundColor="Transparent"
                            Clicked="OnNextClicked"
                            Text="⏭"
                            TextColor="#E5E7EB"
                            FontSize="18"/>
                </Border>

            </VerticalStackLayout>
        </Grid>

        <!-- Topbar -->
        <Grid ZIndex="6"
              Padding="14"
              VerticalOptions="Start"
              HorizontalOptions="Fill"
              ColumnDefinitions="Auto,*,Auto">

            <!-- BACK -->
            <Border Stroke="#26FFFFFF"
                    StrokeThickness="1"
                    BackgroundColor="#dd000000"
                    WidthRequest="56"
                    HeightRequest="56">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>

                <ImageButton Source="backwhite.png"
                             BackgroundColor="Transparent"
                             Padding="14"
                             Clicked="OnBackClicked"/>
            </Border>

            <!-- MENU (placeholder) -->
            <Border Grid.Column="2"
                    Stroke="#26FFFFFF"
                    StrokeThickness="1"
                    BackgroundColor="#dd000000"
                    WidthRequest="56"
                    HeightRequest="56"
                    Opacity="0.9">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>
                <Label Text="⋯"
                       FontSize="22"
                       TextColor="#E5E7EB"
                       HorizontalTextAlignment="Center"
                       VerticalTextAlignment="Center"/>
            </Border>
        </Grid>

    </Grid>
</ContentPage>